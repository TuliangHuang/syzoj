<% this.title = '编辑习题'; %>
<% include header %>
<style type="text/css">
  .problem_header{
    text-align: center;
  }
  .font-content { font-family: inherit; }
  .markdown-edit { font-family: inherit; }
  .padding { padding: 14px; }
  .ui.form textarea { resize: vertical; }
  .ui.form .field > label { font-weight: 600; }
  .code-with-gutter { position: relative; }
  .code-with-gutter .code-gutter {
    position: absolute;
    left: 0;
    top: 0;
    width: 2.5em;
    color: rgba(0, 0, 0, .4);
    text-align: right;
    padding-right: .5em;
    user-select: none;
  }
  .code-with-gutter pre { padding-left: 3em; margin: 0; }
  .code-gutter .code-ln { display: block; }
  .spaced-block { margin-top: 15px; }
  .add-tag-button { height: 38px; }
  .add-tag-row { display: flex; align-items: center; gap: 8px; }
  .add-tag-row .flex-1 { flex: 1 1 auto; }
  .add-tag-inline { display: flex; align-items: center; gap: 6px; }
</style>
<div class="padding">
  <form method="post" action="<%= syzoj.utils.makeUrl(['question', req.params.id, 'edit']) %>">
    <div class="ui top attached tabular menu">
      <a class="item active" data-tab="edit">编辑</a>
      <a class="item" data-tab="preview" id="preview_tab">预览</a>
    </div>
    <div class="ui bottom attached tab segment active" data-tab="edit">
      <div class="ui form"><div class="field">
        <div class="fields">
          <div class="eight wide field">
            <label for="id">
              <% if (question.new) { %>
                题目编号
              <% } else { %>
                修改题目编号
              <% } %>
            </label>
            <input type="text" id="id" name="id" placeholder="留空则自动延伸" value="<%= question.id ? question.id : '' %>">
          </div>
          <div class="eight wide field">
            <label for="parent_id">
              <% if (question.new) { %>
                母题编号
              <% } else { %>
                修改母题编号
              <% } %>
            </label>
            <input class="font-content" type="text" id="parent_id" name="parent_id" value="<%= question.parent_id %>">
          </div>
        </div>
        <div class="field">
          <label for="title">题目名称</label>
          <input class="font-content" type="text" id="title" name="title" value="<%= question.title %>">
        </div>
        <div class="field spaced-block">
          <div class="fields" style="align-items: flex-end; ">
          <div class="eight wide field">
            <label>标签</label>
            <select class="ui fluid search dropdown" multiple="" id="search_tags" name="tags">
              <% for (let tag of (question.tags || [])) { %>
                <option value="<%= tag.id %>" selected><%= tag.name %></option>
              <% } %>
            </select>
          </div>
          <div class="eight wide field">
            <label>添加新标签</label>
            <div class="add-tag-inline">
              <input type="text" id="new_tag_name" class="font-content" placeholder="Name" style="flex: 1 1 auto; ">
              <div class="ui selection dropdown" id="new_tag_color">
                <input type="hidden" value="">
                <i class="dropdown icon"></i>
                <div class="default text">Colors</div>
                <div class="menu">
                  <div class="item" data-value="red">
                    <div class="ui red empty circular label"></div>
                    Red
                  </div>
                  <div class="item" data-value="blue">
                    <div class="ui blue empty circular label"></div>
                    Blue
                  </div>
                  <div class="item" data-value="black">
                    <div class="ui black empty circular label"></div>
                    Black
                  </div>
                  <div class="item" data-value="purple">
                    <div class="ui purple empty circular label"></div>
                    Purple
                  </div>
                  <div class="item" data-value="orange">
                    <div class="ui orange empty circular label"></div>
                    Orange
                  </div>
                  <div class="item" data-value="yellow">
                    <div class="ui yellow empty circular label"></div>
                    Yellow
                  </div>
                  <div class="item" data-value="pink">
                    <div class="ui pink empty circular label"></div>
                    Pink
                  </div>
                  <div class="item" data-value="green">
                    <div class="ui green empty circular label"></div>
                    Green
                  </div>
                  <div class="item" data-value="olive">
                    <div class="ui olive empty circular label"></div>
                    Olive
                  </div>
                  <div class="item" data-value="teal">
                    <div class="ui teal empty circular label"></div>
                    Teal
                  </div>
                  <div class="item" data-value="violet">
                    <div class="ui violet empty circular label"></div>
                    Violet
                  </div>
                </div>
              </div>
              <button type="button" id="add_new_tag_btn" class="ui green icon button add-tag-button" title="添加新标签">
                <i class="plus icon"></i>
              </button>
            </div>
          </div>
          </div>
        </div>
        <div class="field spaced-block">
          <label for="source">来源</label>
          <input class="font-content" type="text" id="source" name="source" value="<%= question.source %>">
        </div>
        <div class="field spaced-block">
          <label for="description">题目描述</label>
          <textarea class="markdown-edit" rows="15" id="description" name="description"><%= question.description %></textarea>
        </div>
        <div class="field spaced-block">
          <label for="answer">标准答案</label>
          <textarea class="markdown-edit" rows="10" id="answer" name="answer"><%= question.answer %></textarea>
        </div>
        <div class="field spaced-block">
          <label for="tutorial">题解</label>
          <textarea class="markdown-edit" rows="10" id="tutorial" name="tutorial"><%= question.tutorial %></textarea>
        </div>
      </div></div>
    </div>
    <div class="ui bottom attached tab segment" data-tab="preview" id="preview">
      <h1 class="ui header problem_header" id="pv-title"></h1>
      <h2 class="ui header">题目</h2>
      <div class="font-content" id="pv-description"></div>
      <div class="ui form" id="pv-items" style="display: none; ">
        <div class="field" id="pv-items-list"></div>
      </div>

      <h2 class="ui header">标准答案</h2>
      <div class="font-content" id="pv-answer"></div>
      <h2 class="ui header">题解</h2>
      <div class="font-content" id="pv-tutorial"></div>
    </div>
    <div style="text-align: center; ">
      <button type="submit" id="submit_button" class="ui labeled submit icon button">
        <i class="icon edit"></i> 提交
      </button>
    </div>
  </form>
</div>
<script type="text/javascript">
$(function () {
  function render(output, input) {
    $.post('/api/markdown', { s: input.val() }, function (s) {
      output.html(s);
      addLineNumbers(output);
    });
  }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, function(c){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c];
    });
  }
  function addLineNumbers($root){
    $root.find('pre > code').each(function(){
      var code = this;
      if (code.getAttribute('data-ln-processed') === '1') return;
      var pre = code.parentNode;
      var $pre = $(pre);
      var $wrapper = $('<div class="code-with-gutter"></div>');
      $pre.before($wrapper);
      $wrapper.append('<div class="code-gutter"></div>');
      $wrapper.append($pre);
      var linesCount = (code.textContent || '').replace(/\n$/, '').split('\n').length;
      var $gutter = $wrapper.find('.code-gutter');
      var lnHtml = '';
      for (var i = 1; i <= linesCount; i++) { lnHtml += '<span class="code-ln">'+ i +'</span>\n'; }
      $gutter.html(lnHtml);
      code.setAttribute('data-ln-processed', '1');
    });
  }
  function renderPreviewDescriptionAndOptions() {
    var text = $('#description').val() || '';
    var parentId = $('#parent_id').val();
    $.post('/api/v2/question/render', { s: text, parent_id: parentId }, function(resp){
      if (!resp || resp.success !== true) return;
      $('#pv-description').html(resp.description || '');
      addLineNumbers($('#pv-description'));
      var $title = $('#pv-items-title');
      var $form = $('#pv-items');
      var $list = $('#pv-items-list');
      if (resp.items && resp.items.length) {
        $title.show();
        $form.show();
        $list.empty();
        if (resp.numberingMode === 'mixed') {
          $list.append('<div class="ui negative message">编号使用不一致：请全部添加编号或全部省略编号。</div>');
          return;
        }
        var onlyOne = (resp.items.length === 1);
        // Use server-side partial rendering to ensure parity with question page
        $.post('/api/v2/question/items/render', { items: JSON.stringify(resp.items), showAllPoints: resp.showAllPoints }, function (html) {
          $list.html(html);
          $('.ui.radio.checkbox, .ui.checkbox').checkbox();
          addLineNumbers($list);
        });
      } else {
        $title.hide();
        $form.hide();
        $list.empty();
      }
    });
  }

  $("#preview_tab").click(function () {
    $("#pv-title").text($("#title").val());
    $("#pv-description, #pv-answer, #pv-tutorial").text('Loading...');
    renderPreviewDescriptionAndOptions();
    render($("#pv-answer"), $("#answer"));
    render($("#pv-tutorial"), $("#tutorial"));
  });
  $('.tabular.menu .item').tab();
});
</script>
<script>
$(function () {
  $('#search_tags')
    .dropdown({
      debug: true,
      saveRemoteData: false,
      apiSettings: {
        url: '/api/v2/search/question-tags/{query}',
        onResponse: function (response) {
          var a = ($('#search_tags').val() || []).map(function (x) { return parseInt(x) });
          if (response.results) {
            response.results = response.results.filter(function(x) { return !a.includes(parseInt(x.value));});
          }
          return response;
        },
        cache: false
      }
    });
  $('#new_tag_color').dropdown();
  $('#add_new_tag_btn').click(function(){
    var name = ($('#new_tag_name').val() || '').trim();
    var color = $('#new_tag_color').dropdown('get value');
    if (!name) {
      return syzoj.alert('请输入标签名称。');
    }
    $.ajax({
      url: '/api/v2/question-tags',
      method: 'POST',
      data: { name: name, color: color },
      success: function(resp){
        if (!resp || resp.success !== true || !resp.tag) {
          return syzoj.alert('创建标签失败。');
        }
        var tag = resp.tag;
        var $dropdown = $('#search_tags');
        // append option if missing
        if ($dropdown.find('option[value="'+ tag.id +'"]').length === 0) {
          $dropdown.append('<option value="'+ tag.id +'">'+ $('<div/>').text(tag.name).html() +'</option>');
        }
        // select in the multi-select so it appears in the UI immediately
        $dropdown.dropdown('set selected', String(tag.id));
        // clear inputs
        $('#new_tag_name').val('');
        $('#new_tag_color').dropdown('clear');
      },
      error: function(){
        syzoj.alert('创建标签失败。');
      }
    });
  });
});
</script>
<% include footer %>
