<% this.title = '编辑习题'; %>
<% include header %>
<style type="text/css">
  .problem_header{
    text-align: center;
  }
  .font-content { font-family: inherit; }
  .markdown-edit { font-family: inherit; }
  .padding { padding: 14px; }
  .ui.form textarea { resize: vertical; }
  .ui.form .field > label { font-weight: 600; }
</style>
<div class="padding">
  <form method="post" action="<%= syzoj.utils.makeUrl(['question', req.params.id, 'edit']) %>">
    <div class="ui top attached tabular menu">
      <a class="item active" data-tab="edit">编辑</a>
      <a class="item" data-tab="preview" id="preview_tab">预览</a>
    </div>
    <div class="ui bottom attached tab segment active" data-tab="edit">
      <div class="ui form"><div class="field">
        <div class="fields">
          <div class="eight wide field">
            <label for="uid">UID</label>
            <input class="font-content" type="text" id="uid" name="uid" value="<%= question.uid %>">
          </div>
          <div class="eight wide field">
            <label for="parent_uid">Parent UID</label>
            <input class="font-content" type="text" id="parent_uid" name="parent_uid" value="<%= question.parent_uid %>">
          </div>
        </div>
        <label for="title">题目名称</label>
        <input class="font-content" type="text" id="title" name="title" value="<%= question.title %>">
        <label style="margin-top: 15px; ">标签</label>
        <select class="ui fluid search dropdown" multiple="" id="search_tags" name="tags">
          <% for (let tag of (question.tags || [])) { %>
            <option value="<%= tag.id %>" selected><%= tag.name %></option>
          <% } %>
        </select>
        <div class="fields">
          <div class="sixteen wide field">
            <label style="margin-top: 15px; " for="source">来源</label>
            <input class="font-content" type="text" id="source" name="source" value="<%= question.source %>">
          </div>
        </div>
        <label style="margin-top: 15px; " for="description">题目描述</label>
        <textarea class="markdown-edit" rows="15" id="description" name="description"><%= question.description %></textarea>
        <label style="margin-top: 15px; " for="answer">标准答案</label>
        <textarea class="markdown-edit" rows="10" id="answer" name="answer"><%= question.answer %></textarea>
        <label style="margin-top: 15px; " for="tutorial">题解</label>
        <textarea class="markdown-edit" rows="10" id="tutorial" name="tutorial"><%= question.tutorial %></textarea>
      </div></div>
    </div>
    <div class="ui bottom attached tab segment" data-tab="preview" id="preview">
      <h1 class="ui header problem_header" id="pv-title"></h1>
      <h2 class="ui header">题目</h2>
      <div class="font-content" id="pv-description"></div>
      <div class="ui form" id="pv-items" style="display: none; ">
        <div class="field" id="pv-items-list"></div>
      </div>

      <h2 class="ui header">标准答案</h2>
      <div class="font-content" id="pv-answer"></div>
      <h2 class="ui header">题解</h2>
      <div class="font-content" id="pv-tutorial"></div>
    </div>
    <div style="text-align: center; ">
      <button type="submit" id="submit_button" class="ui labeled submit icon button">
        <i class="icon edit"></i> 提交
      </button>
    </div>
  </form>
</div>
<script type="text/javascript">
$(function () {
  function render(output, input) {
    $.post('/api/markdown', { s: input.val() }, function (s) {
      output.html(s);
    });
  }
  function renderPreviewDescriptionAndOptions() {
    var text = $('#description').val() || '';
    $.post('/api/v2/question/render', { s: text }, function(resp){
      if (!resp || resp.success !== true) return;
      $('#pv-description').html(resp.description || '');
      var $title = $('#pv-items-title');
      var $form = $('#pv-items');
      var $list = $('#pv-items-list');
      if (resp.items && resp.items.length) {
        $title.show();
        $form.show();
        $list.empty();
        if (resp.numberingMode === 'mixed') {
          $list.append('<div class="ui negative message">编号使用不一致：请全部添加编号或全部省略编号。</div>');
          return;
        }
        var onlyOne = (resp.items.length === 1);
        resp.items.forEach(function(it){
          var seg = $('<div class="ui segment basic" style="border: none; box-shadow: none; padding: 0; "></div>');
          if (!onlyOne || it.prompt) {
            var $row = $('<div class="font-content" style="margin-bottom: 1em; display: flex; align-items: baseline; gap: 6px; flex-wrap: wrap; "></div>');
            if (!onlyOne) { $row.append('<span>'+ it.num +'.</span>'); }
            if (it.prompt) { $row.append('<div style="flex: 1 1 auto; min-width: 0; ">'+ it.prompt +'</div>'); }
            if (resp.showAllPoints) { $row.append('<span class="q-pts">（'+ (it.points || 1) +'分）</span>'); }
            seg.append($row);
          }
          if (it.type === 'mc' || it.type === 'ms') {
            var grouped = $('<div class="grouped fields"></div>');
            (it.options || []).forEach(function(opt, i){
              var isSingle = (it.type === 'mc');
              var node = $('<div class="field">\n  <div class="ui '+(isSingle ? 'radio' : 'checkbox')+' checkbox">\n    <input type="'+(isSingle ? 'radio' : 'checkbox')+'" name="q['+ it.num +']" value="'+i+'">\n    <label style=\"display: inline-flex; align-items: baseline; gap: 6px; \" ><span>'+String.fromCharCode(65 + i)+'.</span><span style=\"display: inline-block; white-space: normal; \" >'+opt+'</span></label>\n  </div>\n</div>');
              grouped.append(node);
            });
            seg.append(grouped);
          } else if (it.type === 'tf') {
            var tf = $('<div class="grouped fields">\n  <div class="field"><div class="ui radio checkbox"><input type="radio" name="q['+ it.num +']" value="T"><label>True</label></div></div>\n  <div class="field"><div class="ui radio checkbox"><input type="radio" name="q['+ it.num +']" value="F"><label>False</label></div></div>\n</div>');
            seg.append(tf);
          } else if (it.type === 'cl') {
            seg.append('<input type="text" name="q['+ it.num +']">');
          } else if (it.type === 'fr') {
            seg.append('<textarea name="q['+ it.num +']" rows="5"></textarea>');
          }
          $list.append(seg);
        });
        $('.ui.radio.checkbox, .ui.checkbox').checkbox();
      } else {
        $title.hide();
        $form.hide();
        $list.empty();
      }
    });
  }

  $("#preview_tab").click(function () {
    $("#pv-title").text($("#title").val());
    $("#pv-description, #pv-answer, #pv-tutorial").text('Loading...');
    renderPreviewDescriptionAndOptions();
    render($("#pv-answer"), $("#answer"));
    render($("#pv-tutorial"), $("#tutorial"));
  });
  $('.tabular.menu .item').tab();
});
</script>
<script>
$(function () {
  $('#search_tags')
    .dropdown({
      debug: true,
      saveRemoteData: false,
      apiSettings: {
        url: '/api/v2/search/question-tags/{query}',
        onResponse: function (response) {
          var a = ($('#search_tags').val() || []).map(function (x) { return parseInt(x) });
          if (response.results) {
            response.results = response.results.filter(function(x) { return !a.includes(parseInt(x.value));});
          }
          return response;
        },
        cache: false
      }
    });
});
</script>
<% include footer %>
