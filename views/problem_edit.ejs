<% this.title = '编辑题目'; %>
<% include header %>
<style type="text/css">
  .problem_header{
    text-align: center;
  }
  .difficulty-input-wrapper {
    position: relative;
    width: 100%;
  }
  .difficulty-input-wrapper input {
    width: 100%;
    padding-right: 32px;
    -moz-appearance: textfield;
  }
  .difficulty-input-wrapper input::-webkit-outer-spin-button,
  .difficulty-input-wrapper input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .difficulty-input-wrapper::after {
    content: '\f0d7';
    font-family: 'Icons';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: rgba(0,0,0,0.4);
  }
  .difficulty-preset-menu {
    position: absolute;
    left: 0;
    right: 0;
    top: calc(100% + 4px);
    background: #fff;
    border: 1px solid rgba(34,36,38,.15);
    border-radius: 0 0 4px 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 5;
    margin-top: 2px;
    max-height: 220px;
    overflow-y: auto;
    display: none;
  }
  .difficulty-preset-menu.visible {
    display: block;
  }
  .difficulty-preset-menu .item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 13px;
  }
  .difficulty-preset-menu .item:hover {
    background: rgba(0,0,0,0.05);
  }
</style>
<div class="padding">
    <form method="post" action="<%= syzoj.utils.makeUrl(['problem', req.params.id, 'edit']) %>">
      <div class="ui top attached tabular menu">
        <a class="item active" data-tab="edit">编辑</a>
        <a class="item" data-tab="preview" id="preview_tab">预览</a>
        <a class="item" data-tab="import" id="import_tab">导入</a>
      </div>
      <div class="ui bottom attached tab segment active" data-tab="edit">
        <div class="ui form"><div class="field">
          <% if (problem.allowedManage) { %>
            <label for="id">
              <% if (problem.new) { %>
                题目编号
              <% } else { %>
                修改题目编号
              <% } %>
            </label>
            <input type="text" id="id" name="id" placeholder="<% if (problem.new) { %>留空则自动延伸<% } else { %>留空则不修改<% } %>" value="<%= problem.id ? problem.id : '' %>">

            <div style="margin-top: 15px; "></div>
          <% } %>
          <%
            const difficultyPresets = (syzoj.constants && syzoj.constants.difficultyColorStops) || [];
          %>
          <label for="title">题目名称</label>
          <input class="font-content" type="text" id="title" name="title" value="<%= problem.title %>">
          <div class="fields" style="margin-bottom: 0px; ">
            <div class="fourteen wide field">
              <label style="margin-top: 15px; ">标签</label>
              <select class="ui fluid search dropdown" multiple="" id="search_tags" name="tags">
                <% for (let tag of problem.tags) { %>
                  <option value="<%= tag.id %>" selected><%= tag.name %></option>
                <% } %>
              </select>
            </div>
            <div class="two wide field">
              <label style="margin-top: 15px; " for="difficulty">难度</label>
              <div class="ui input difficulty-input-wrapper">
                <input class="font-content" type="number" id="difficulty" name="difficulty" step="100" value="<%= problem.difficulty == null ? '' : problem.difficulty %>" style="<% if (problem.difficulty != null && syzoj.utils && syzoj.utils.getDifficultyColor) { %>color: <%= syzoj.utils.getDifficultyColor(problem.difficulty) %>;<% } %>" autocomplete="off">
                <div class="difficulty-preset-menu" id="difficulty_preset_menu">
                  <% difficultyPresets.forEach(function (preset) { %>
                    <div class="item" data-value="<%= preset.value %>" style="<% if (preset && Array.isArray(preset.color)) { %>color: rgb(<%= preset.color.join(', ') %>);<% } %>"><%= preset.value %></div>
                  <% }); %>
                </div>
              </div>
            </div>
          </div>
          <div class="fields" style="margin-bottom: 0px; ">
            <div class="seven wide field">
              <label style="margin-top: 15px; " for="source">原题链接</label>
              <input class="font-content" type="text" id="source" name="source" value="<%= problem.source %>">
            </div>
            <div class="seven wide field">
              <label style="margin-top: 15px; " for="luogu_url">洛谷链接</label>
              <input class="font-content" type="text" id="luogu_url" name="luogu_url" value="<%= problem.luogu_url %>">
            </div>
            <div class="two wide field">
              <label style="margin-top: 15px; " for="bzoj_id">BZOJ</label>
              <input class="font-content" type="number" id="bzoj_id" name="bzoj_id" value="<%= problem.bzoj_id %>">
            </div>
          </div>
          <label style="margin-top: 15px; " for="description">题目描述</label>
          <textarea class="markdown-edit" rows="15" id="description" name="description"><%= problem.description %></textarea>
          <label style="margin-top: 15px; " for="input_format">输入格式</label>
          <textarea class="markdown-edit" rows="10" id="input" name="input_format"><%= problem.input_format %></textarea>
          <label style="margin-top: 15px; " for="output_format">输出格式</label>
          <textarea class="markdown-edit" rows="10" id="output" name="output_format"><%= problem.output_format %></textarea>
          <label style="margin-top: 15px; ">样例</label>
          <textarea class="markdown-edit" rows="15" id="example" name="example"><%= problem.example %></textarea>
          <label style="margin-top: 15px; ">数据范围与提示</label>
          <textarea class="markdown-edit" rows="10" id="hint" name="limit_and_hint"><%= problem.limit_and_hint %></textarea>
          <div class="ui <% if (problem.is_anonymous) { %>checked <% } %>checkbox" style="margin-top: 15px; ">
            <input <% if (problem.is_anonymous) { %>checked=""<% } %> name="is_anonymous" type="checkbox">
            <label><strong>匿名上传</strong></label>
            <p style="margin-top: 5px; ">选择后，上传者的用户名将不在题目页面中显示。</p>
          </div>
        </div></div>
      </div>
      <div class="ui bottom attached tab segment" data-tab="preview" id="preview">
        <h1 class="ui header problem_header" id="pv-title"></h1>
        <h2 class="ui header">题目描述</h2>
        <div class="font-content" id="pv-description"></div>
        <h2 class="ui header">输入格式</h2>
        <div class="font-content" id="pv-input"></div>
        <h2 class="ui header">输出格式</h2>
        <div class="font-content" id="pv-output"></div>
        <h2 class="ui header">样例</h2>
        <div class="font-content" id="pv-example"></div>
        <h2 class="ui header">数据范围与提示</h2>
        <div class="font-content" id="pv-hint"></div>
      </div>
      <div class="ui bottom attached tab segment" data-tab="import" id="import">
        <div class="ui form"><div class="field">
          <label style="margin-top: 15px; " for="raw_code">导入源码</label>
          <textarea class="markdown-edit" rows="50" id="raw_code" name="raw_code"></textarea>
        </div></div>
      </div>
      <% if (problem.allowedEdit) { %>
      <div style="text-align: center; ">
      <button type="submit" id="submit_button" class="ui labeled submit icon button">
        <i class="icon edit"></i> 提交
      </button>
      </div>
      <% } %>
    </form>
</div>
<script type="text/javascript">
$(function () {
    function render(output, input) {
      $.post('/api/markdown', { s: input.val() }, function (s) {
        output.html(s);
      });
    }
    $("#preview_tab").click(function () {
      $("#pv-title").text($("#title").val());
      $("#pv-description, #pv-input, #pv-output, #pv-example, #pv-hint").text('Loading...');
      render($("#pv-description"), $("#description"));
      render($("#pv-input"), $("#input"));
      render($("#pv-output"), $("#output"));
      render($("#pv-example"), $("#example"));
      render($("#pv-hint"), $("#hint"));
    });
    $('.tabular.menu .item').tab();
});
</script>
<script>
$(function () {
  $('#search_tags')
    .dropdown({
      debug: true,
      saveRemoteData: false,
      apiSettings: {
        url: '/api/v2/search/tags/{query}',
        onResponse: function (response) {
          var a = $('#search_tags').val().map(function (x) { return parseInt(x) });
          if (response.results) {
            response.results = response.results.filter(function(x) { return !a.includes(parseInt(x.value));});
          }
          return response;
        },
        cache: false
      }
    });
});
</script>
<script>
$(function() {
  const difficultyColorStops = <%- JSON.stringify(difficultyPresets) %>;

  function getDifficultyColor(value) {
    if (!difficultyColorStops.length) return '';
    const numericValue = Number(value);
    if (!Number.isFinite(numericValue)) return '';
    if (numericValue <= difficultyColorStops[0].value) {
      return `rgb(${difficultyColorStops[0].color.join(', ')})`;
    }
    if (numericValue >= difficultyColorStops[difficultyColorStops.length - 1].value) {
      return `rgb(${difficultyColorStops[difficultyColorStops.length - 1].color.join(', ')})`;
    }
    for (let i = 0; i < difficultyColorStops.length - 1; i++) {
      const start = difficultyColorStops[i];
      const end = difficultyColorStops[i + 1];
      if (numericValue >= start.value && numericValue <= end.value) {
        const ratio = (numericValue - start.value) / (end.value - start.value);
        const interpolated = start.color.map((component, idx) =>
          Math.round(component + (end.color[idx] - component) * ratio)
        );
        return `rgb(${interpolated.join(', ')})`;
      }
    }
    return '';
  }

  function applyDifficultyColorStyle(value) {
    const color = getDifficultyColor(value);
    $('#difficulty').css('color', color || '');
  }

  const $difficulty = $('#difficulty');
  const $presetMenu = $('#difficulty_preset_menu');
  let hideMenuTimer = null;

  function showPresetMenu() {
    clearTimeout(hideMenuTimer);
    $presetMenu.addClass('visible');
  }

  function scheduleHidePresetMenu() {
    hideMenuTimer = setTimeout(() => $presetMenu.removeClass('visible'), 120);
  }

  $difficulty.on('focus click', function () {
    showPresetMenu();
  });

  $difficulty.on('blur', function () {
    scheduleHidePresetMenu();
  });

  $presetMenu.on('mousedown', '.item', function (e) {
    e.preventDefault();
    const value = $(this).data('value');
    if (value !== undefined) {
      $difficulty.val(value).trigger('change');
      applyDifficultyColorStyle(value);
    }
    $presetMenu.removeClass('visible');
  });

  $('#difficulty').on('input change', function () {
    applyDifficultyColorStyle($(this).val());
  });

  applyDifficultyColorStyle($difficulty.val());
});
</script>
<% include footer %>
