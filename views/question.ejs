<% this.title = (question && question.title ? question.title : '习题') + ' - 习题'; %>
<% include header %>

<style>
  /* Grid layout for aligned line numbers + code (consistent with submission page) */
  .codebox-grid { display: grid; grid-template-columns: 4.5em 1fr; align-items: stretch; }
  .codebox-grid .line-numbers {
    text-align: right;
    margin-right: 0;
    color: rgba(0, 0, 0, 0.4);
    user-select: none;
    -webkit-user-select: none;
    overflow: hidden;
    position: relative;
    font-family: "Fira Mono", "Monaco", "Menlo", "Ubuntu Mono", "Consolas", "source-code-pro", monospace;
  }
  .codebox-grid .line-numbers .line-number { display: block; width: 3.25em; margin-right: 1.25em; }
  .codebox-grid pre { margin-top: 0; margin-bottom: 0; overflow: auto; position: relative; padding: 0; }
  /* Match fonts between line numbers and code for perfect vertical alignment */
  .codebox-grid pre, .codebox-grid pre code { font-family: "Fira Mono", "Monaco", "Menlo", "Ubuntu Mono", "Consolas", "source-code-pro", monospace; }
  pre > code.code-with-lines { display: block; padding: 0; }
  .font-content pre { margin: 0 0 1em 0; }
  /* Scope: tighten segment horizontally for this page */
  #question_content .ui.segment.with-lines { padding-left: 0 !important; padding-right: 0 !important; }
  /* When a UI segment directly contains an option code block grid, make its border transparent and remove vertical padding */
  .ui.segment:has(.option-content .codebox-grid) {
    border-color: transparent !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
  }
</style>

<span id="question_content">
<div class="ui center aligned grid">
  <div class="row">
    <h1 class="ui header">
      <%= question.title || ('#' + question.id) %>
    </h1>
  </div>
  <% if (question.source) { %>
  <div class="row" style="margin-top: -15px">
    <div class="ui label">来源<div class="detail"><%= question.source %></div></div>
  </div>
  <% } %>
  <% if (question.tags && question.tags.length) { %>
  <div class="row“ style="margin-top: -15px">
    <% for (let tag of question.tags) { %>
      <a href="<%= syzoj.utils.makeUrl(['questions', 'tag', tag.id]) %>" class="ui <%= tag.color %> label"><%= tag.name %></a>
    <% } %>
  </div>
  <% } %>
</div>

<div class="ui grid">
  <% if (allowedEdit) { %>
  <div class="row">
    <div class="column">
      <div class="ui tiny buttons right floated">
        <a class="ui button" href="<%= syzoj.utils.makeUrl(['question', question.id, 'edit']) %>">编辑</a>
      </div>
    </div>
  </div>
  <% } %>
  <div class="row" style="padding-bottom: 0; ">
    <div class="column">
      <h2 class="ui header"><%= (question && question.type) ? question.type : '题目' %></h2>
      <% if (descriptionHtml) { %>
      <div class="font-content"><%- descriptionHtml %></div>
      <% } %>
    </div>
  </div>
  
  <% if (items && items.length) { %>
  <div class="row">
    <div class="column">
      <div class="ui form">
        <div class="field">
          <% include question_items %>
        </div>
      </div>
    </div>
  </div>
  <% } %>

  <% if (canViewSolutions && answerHtml) { %>
  <div class="row">
    <div class="column">
      <h2 class="ui header">标准答案</h2>
      <div class="font-content"><%- answerHtml %></div>
    </div>
  </div>
  <% } %>
  <% if (canViewSolutions && tutorialHtml) { %>
  <div class="row">
    <div class="column">
      <h2 class="ui header">题解</h2>
      <div class="font-content"><%- tutorialHtml %></div>
    </div>
  </div>
  <% } %>
</div>

<div class="ui center aligned grid" style="margin-top: 20px;">
  <div class="row">
    <div class="ui pagination menu">
    <% if (randomUrl) { %>
        <a class="icon item" href="<%= randomUrl %>" title="随机下一题" aria-label="随机下一题"><i class="random icon"></i></a>
    <% } else { %>
        <% if (prevUrl) { %>
        <a class="icon item" href="<%= prevUrl %>" title="上一题" aria-label="上一题"><i class="arrow left icon"></i></a>
        <% } %>
        <% if (nextUrl) { %>
        <a class="icon item" href="<%= nextUrl %>" title="下一题" aria-label="下一题"><i class="arrow right icon"></i></a>
        <% } %>
    <% } %>
    </div>
  </div>
</div>

<script>
$(function(){
  $('.ui.radio.checkbox').checkbox();
  $('.ui.checkbox').checkbox();
  function prepareCodeGrids($root){
    $root.find('pre > code').each(function(){
      var code = this;
      if (code.getAttribute('data-ln-processed') === '1') return;
      var pre = code.parentNode;
      var $pre = $(pre);
      var $grid = $('<div class="codebox-grid"></div>');
      $pre.before($grid);
      $grid.append('<div class="line-numbers"></div>');
      $grid.append($pre);
      if (!$(code).hasClass('code-with-lines')) $(code).addClass('code-with-lines');
      code.setAttribute('data-ln-processed', '1');
    });
  }
  function applyLineNumbers($scope){
    $scope.find('.codebox-grid').each(function(){
      var grid = this;
      var codeEl = grid.querySelector('code.code-with-lines');
      var lnEl = grid.querySelector('.line-numbers');
      if (!codeEl || !lnEl) return;
      var rawText = codeEl.textContent || '';
      // Use a trimmed copy for counting lines (do not mutate highlighted HTML)
      var countedText = rawText.replace(/(?:\r\n|\r|\n)+$/, '');
      if (lnEl.getAttribute('data-ln-applied') === '1' && lnEl.getAttribute('data-ln-for') === countedText) return;

      var lines = countedText.split(/\r\n|\r|\n/);
      if (lines.length <= 1) {
        lnEl.innerHTML = '';
        lnEl.setAttribute('data-ln-applied', '1');
        lnEl.setAttribute('data-ln-for', countedText);
        return;
      }
      var nums = [];
      for (var i = 1; i <= lines.length; i++) nums.push('<span class="line-number">' + i + '</span>');
      lnEl.innerHTML = nums.join('');
      lnEl.setAttribute('data-ln-applied', '1');
      lnEl.setAttribute('data-ln-for', countedText);

      var pre = grid.querySelector('pre');
      if (pre) {
        pre.addEventListener('scroll', function () {
          lnEl.scrollTop = pre.scrollTop;
        });
      }
    });
  }
  var $scope = $('.font-content');
  prepareCodeGrids($scope);
  applyLineNumbers($scope);
});
</script>

</span>
<% include footer %>
