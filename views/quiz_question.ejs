<% this.title = (quiz && quiz.title ? quiz.title : ('小测 #' + quiz.id)) + ' - 小测'; %>
<% include header %>

<style>
  .code-with-gutter { position: relative; }
  .code-with-gutter .code-gutter {
    position: absolute;
    left: 0;
    top: 0;
    width: 2.5em;
    color: rgba(0, 0, 0, .4);
    text-align: right;
    padding-right: .5em;
    user-select: none;
  }
  .code-with-gutter pre { padding-left: 3em; margin: 0; }
  .code-gutter .code-ln { display: block; }
  .font-content pre { margin: 0 0 1em 0; }
  </style>

<div class="ui center aligned grid">
  <div class="row">
    <div class="ui secondary pointing menu">
      <a class="item" href="<%= syzoj.utils.makeUrl(['quiz', quiz.id]) %>" title="返回小测" aria-label="返回小测"><i class="bars icon"></i></a>
      <% dir.forEach(function(d){ %>
        <a class="item <%= d.idx === qid ? 'active' : '' %>" href="<%= d.url %>">#<%= d.idx %>（<%= d.points %>分）</a>
      <% }) %>
    </div>
  </div>
  <div class="row">
    <div class="column">
      <h2 class="ui header">
        <% if (user && user.is_admin) { %>
          <a href="<%= syzoj.utils.makeUrl(['question', question.id]) %>">第 <%= qid %> 题</a>
        <% } else { %>
          第 <%= qid %> 题
        <% } %>
      </h2>
    </div>
  </div>
</div>

<div class="ui grid">
  <div class="row" style="padding-bottom: 0; ">
    <div class="column">
      <h2 class="ui header"><%= (question && question.type) ? question.type : '题目' %></h2>
      <% if (descriptionHtml) { %>
      <div class="font-content"><%- descriptionHtml %></div>
      <% } %>
    </div>
  </div>
  <% if (items && items.length) { %>
  <div class="row">
    <div class="column">
      <form id="qq-form" class="ui form" method="post" action="<%= syzoj.utils.makeUrl(['quiz', quiz.id, 'question', qid, 'save'], aid ? { aid } : null) %>">
        <input type="hidden" name="aid" value="<%= aid || '' %>">
        <div class="field">
          <% include question_items %>
        </div>
        <div id="autosave-status" class="ui tiny text" style="margin-top: 6px; color: rgba(0,0,0,.5); "></div>
      </form>
    </div>
  </div>
  <% } %>
</div>

<div class="ui center aligned grid" style="margin-top: 20px;">
  <div class="row">
    <div class="ui pagination menu">
      <% if (prevUrl) { %>
      <a class="icon item" href="<%= prevUrl %>" title="上一题" aria-label="上一题"><i class="arrow left icon"></i></a>
      <% } else { %>
      <a class="icon item" href="<%= syzoj.utils.makeUrl(['quiz', quiz.id]) %>" title="返回" aria-label="返回"><i class="close icon"></i></a>
      <% } %>
      <% if (nextUrl) { %>
      <a class="icon item" href="<%= nextUrl %>" title="下一题" aria-label="下一题"><i class="arrow right icon"></i></a>
      <% } else { %>
      <a class="icon item" href="<%= syzoj.utils.makeUrl(['quiz', quiz.id]) %>" title="返回" aria-label="返回"><i class="check icon"></i></a>
      <% } %>
    </div>
  </div>
</div>


<script>
$(function(){
  $('.ui.radio.checkbox').checkbox();
  $('.ui.checkbox').checkbox();
  var $form = $('#qq-form');
  var $status = $('#autosave-status');

  function setStatus(text) {
    if (!$status.length) return;
    $status.text(text);
  }

  var saveInFlight = false;
  var saveQueued = false;
  function doSave(next) {
    if (!$form.length) return Promise.resolve();
    var data = $form.serializeArray();
    if (next) data.push({ name: 'next', value: '1' });
    saveInFlight = true;
    setStatus('正在保存…');
    return $.ajax({
      url: $form.attr('action'),
      type: 'POST',
      data: $.param(data),
    }).then(function(){
      setStatus('已保存');
    }).catch(function(){
      setStatus('保存失败，稍后重试');
    }).always(function(){
      saveInFlight = false;
      if (saveQueued) { saveQueued = false; doSave(); }
    });
  }

  var debounced;
  function queueSave() {
    if (debounced) clearTimeout(debounced);
    debounced = setTimeout(function(){
      if (saveInFlight) { saveQueued = true; return; }
      doSave();
    }, 400);
  }

  // Auto-save on interactions
  $(document).on('change', '#qq-form input, #qq-form textarea', queueSave);
  $(document).on('input', '#qq-form input[type=text], #qq-form textarea', queueSave);

  // Intercept pagination clicks to save before navigation
  $('.ui.pagination.menu a').on('click', function(e){
    if (!$form.length) return;
    e.preventDefault();
    var href = $(this).attr('href');
    doSave().then(function(){ window.location.href = href; });
  });
  function addLineNumbers($root){
    $root.find('pre > code').each(function(){
      var code = this;
      if (code.getAttribute('data-ln-processed') === '1') return;
      var pre = code.parentNode;
      var $pre = $(pre);
      var $wrapper = $('<div class="code-with-gutter"></div>');
      $pre.before($wrapper);
      $wrapper.append('<div class="code-gutter"></div>');
      $wrapper.append($pre);
      var linesCount = (code.textContent || '').replace(/\n$/, '').split('\n').length;
      var $gutter = $wrapper.find('.code-gutter');
      var lnHtml = '';
      for (var i = 1; i <= linesCount; i++) { lnHtml += '<span class="code-ln">'+ i +'</span>\n'; }
      $gutter.html(lnHtml);
      code.setAttribute('data-ln-processed', '1');
    });
  }
  // Apply to entire page to cover code blocks inside question items and options
  addLineNumbers($(document.body));
});
</script>

<% include footer %>